# æ¶ˆæ¯è¾“å…¥ç»„ä»¶

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [MessageInput.tsx](file://src/components/MessageInput.tsx)
- [EmptyChatMessageInput.tsx](file://src/components/EmptyChatMessageInput.tsx)
- [Attach.tsx](file://src/components/MessageInputActions/Attach.tsx)
- [AttachSmall.tsx](file://src/components/MessageInputActions/AttachSmall.tsx)
- [ChatModelSelector.tsx](file://src/components/MessageInputActions/ChatModelSelector.tsx)
- [Optimization.tsx](file://src/components/MessageInputActions/Optimization.tsx)
- [Sources.tsx](file://src/components/MessageInputActions/Sources.tsx)
- [useChat.tsx](file://src/lib/hooks/useChat.tsx)
- [actions.ts](file://src/lib/actions.ts)
- [layout.tsx](file://src/app/layout.tsx)
- [globals.css](file://src/app/globals.css)
- [tailwind.config.ts](file://src/tailwind.config.ts)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
5. [è¯¦ç»†ç»„ä»¶åˆ†æ](#è¯¦ç»†ç»„ä»¶åˆ†æ)
6. [ä¾èµ–å…³ç³»åˆ†æ](#ä¾èµ–å…³ç³»åˆ†æ)
7. [æ€§èƒ½è€ƒè™‘](#æ€§èƒ½è€ƒè™‘)
8. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)
9. [ç»“è®º](#ç»“è®º)

## ç®€ä»‹
æœ¬æ–‡æ¡£æ·±å…¥ä»‹ç»äº† Perplexica é¡¹ç›®ä¸­çš„æ¶ˆæ¯è¾“å…¥ç›¸å…³ç»„ä»¶ï¼ŒåŒ…æ‹¬ MessageInput å’Œ EmptyChatMessageInput ä¸¤ä¸ªæ ¸å¿ƒè¾“å…¥ç»„ä»¶ï¼Œä»¥åŠå®ƒä»¬çš„å­ç»„ä»¶ MessageInputActionsã€‚è¿™äº›ç»„ä»¶æä¾›äº†å®Œæ•´çš„æ¶ˆæ¯è¾“å…¥ä½“éªŒï¼ŒåŒ…æ‹¬æ–‡æœ¬è¾“å…¥ã€å¿«æ·é”®æ”¯æŒã€æ–‡ä»¶é™„ä»¶ä¸Šä¼ ã€æ¨¡å‹é€‰æ‹©ã€ä¼˜åŒ–é€‰é¡¹å’Œæ¥æºç®¡ç†ç­‰åŠŸèƒ½ã€‚

## é¡¹ç›®ç»“æ„
æ¶ˆæ¯è¾“å…¥ç»„ä»¶ä½äº `src/components` ç›®å½•ä¸‹ï¼Œé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œå°†è¾“å…¥åŠŸèƒ½åˆ†è§£ä¸ºç‹¬ç«‹çš„å¯å¤ç”¨ç»„ä»¶ï¼š

```mermaid
graph TB
subgraph "æ¶ˆæ¯è¾“å…¥ç»„ä»¶"
MI[MessageInput<br/>ä¸»è¾“å…¥ç»„ä»¶]
EMI[EmptyChatMessageInput<br/>ç©ºèŠå¤©è¾“å…¥ç»„ä»¶]
subgraph "è¾“å…¥åŠ¨ä½œç»„ä»¶"
ATT[Attach<br/>æ–‡ä»¶é™„ä»¶]
ATTS[AttachSmall<br/>å°å‹é™„ä»¶]
MS[ChatModelSelector<br/>æ¨¡å‹é€‰æ‹©å™¨]
OPT[Optimization<br/>ä¼˜åŒ–æ¨¡å¼]
SRC[Sources<br/>æ¥æºç®¡ç†]
end
end
subgraph "çŠ¶æ€ç®¡ç†"
UC[useChat Hook<br/>èŠå¤©çŠ¶æ€ç®¡ç†]
ACT[actions.ts<br/>è¾…åŠ©åŠŸèƒ½]
end
MI --> ATT
MI --> ATTS
EMI --> ATT
EMI --> MS
EMI --> OPT
EMI --> SRC
ATT --> UC
ATTS --> UC
MS --> UC
OPT --> UC
SRC --> UC
UC --> ACT
```

**å›¾è¡¨æ¥æº**
- [MessageInput.tsx](file://src/components/MessageInput.tsx#L1-L103)
- [EmptyChatMessageInput.tsx](file://src/components/EmptyChatMessageInput.tsx#L1-L89)
- [Attach.tsx](file://src/components/MessageInputActions/Attach.tsx#L1-L170)
- [ChatModelSelector.tsx](file://src/components/MessageInputActions/ChatModelSelector.tsx#L1-L204)

**ç« èŠ‚æ¥æº**
- [MessageInput.tsx](file://src/components/MessageInput.tsx#L1-L103)
- [EmptyChatMessageInput.tsx](file://src/components/EmptyChatMessageInput.tsx#L1-L89)

## æ ¸å¿ƒç»„ä»¶
æ¶ˆæ¯è¾“å…¥ç³»ç»Ÿç”±ä¸¤ä¸ªä¸»è¦ç»„ä»¶æ„æˆï¼šMessageInputï¼ˆç”¨äºç°æœ‰èŠå¤©ï¼‰å’Œ EmptyChatMessageInputï¼ˆç”¨äºæ–°èŠå¤©æˆ–ç©ºçŠ¶æ€ï¼‰ã€‚

### MessageInput ç»„ä»¶
MessageInput æ˜¯èŠå¤©ç•Œé¢ä¸­çš„ä¸»è¦è¾“å…¥ç»„ä»¶ï¼Œæä¾›æ™ºèƒ½çš„å¤šè¡Œè¾“å…¥æ”¯æŒå’Œå¿«æ·é”®å¤„ç†ï¼š

- **è‡ªé€‚åº”å¸ƒå±€**ï¼šæ ¹æ®è¾“å…¥å†…å®¹è‡ªåŠ¨åœ¨å•è¡Œå’Œå¤šè¡Œæ¨¡å¼é—´åˆ‡æ¢
- **æ™ºèƒ½é«˜åº¦è°ƒæ•´**ï¼šä½¿ç”¨ TextareaAutosize å®ç°åŠ¨æ€é«˜åº¦è°ƒæ•´
- **å¿«æ·é”®æ”¯æŒ**ï¼šæ”¯æŒ "/" é”®å¿«é€Ÿèšç„¦è¾“å…¥æ¡†
- **æäº¤é€»è¾‘**ï¼šæ”¯æŒ Enter é”®æäº¤ï¼ŒShift+Enter è¿›è¡Œæ¢è¡Œ
- **åŠ è½½çŠ¶æ€ç®¡ç†**ï¼šé˜²æ­¢é‡å¤æäº¤

### EmptyChatMessageInput ç»„ä»¶
EmptyChatMessageInput ä¸“ä¸ºç©ºèŠå¤©çŠ¶æ€è®¾è®¡ï¼Œæä¾›å®Œæ•´çš„é…ç½®é€‰é¡¹ï¼š

- **å®Œæ•´é…ç½®é¢æ¿**ï¼šåŒ…å«ä¼˜åŒ–æ¨¡å¼ã€æ¨¡å‹é€‰æ‹©ã€æ–‡ä»¶é™„ä»¶ç­‰æ‰€æœ‰é…ç½®é€‰é¡¹
- **è‡ªåŠ¨ç„¦ç‚¹ç®¡ç†**ï¼šé¡µé¢åŠ è½½æ—¶è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
- **ç®€æ´çš„æäº¤ç•Œé¢**ï¼šæä¾›æ¸…æ™°çš„æäº¤æŒ‰é’®å’Œé…ç½®é€‰é¡¹
- **å“åº”å¼è®¾è®¡**ï¼šé€‚é…ä¸åŒå±å¹•å°ºå¯¸

**ç« èŠ‚æ¥æº**
- [MessageInput.tsx](file://src/components/MessageInput.tsx#L8-L103)
- [EmptyChatMessageInput.tsx](file://src/components/EmptyChatMessageInput.tsx#L10-L89)

## æ¶æ„æ¦‚è§ˆ
æ¶ˆæ¯è¾“å…¥ç»„ä»¶é‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œé€šè¿‡ useChat Hook å®ç°çŠ¶æ€å…±äº«å’Œæ•°æ®æµç®¡ç†ï¼š

```mermaid
sequenceDiagram
participant U as ç”¨æˆ·
participant MI as MessageInput
participant UC as useChat Hook
participant API as åç«¯API
participant ST as çŠ¶æ€ç®¡ç†
U->>MI : è¾“å…¥æ–‡æœ¬
MI->>MI : æ›´æ–°æœ¬åœ°çŠ¶æ€
MI->>UC : è°ƒç”¨ sendMessage()
UC->>ST : è®¾ç½® loading çŠ¶æ€
UC->>API : å‘é€è¯·æ±‚
API-->>UC : æµå¼å“åº”
UC->>ST : æ›´æ–°æ¶ˆæ¯çŠ¶æ€
UC-->>MI : è¿”å›ç»“æœ
MI->>MI : æ¸…ç©ºè¾“å…¥æ¡†
Note over MI,UC : æäº¤æµç¨‹
```

**å›¾è¡¨æ¥æº**
- [MessageInput.tsx](file://src/components/MessageInput.tsx#L49-L62)
- [useChat.tsx](file://src/lib/hooks/useChat.tsx#L714-L806)

**ç« èŠ‚æ¥æº**
- [useChat.tsx](file://src/lib/hooks/useChat.tsx#L31-L62)
- [layout.tsx](file://src/app/layout.tsx#L35-L55)

## è¯¦ç»†ç»„ä»¶åˆ†æ

### MessageInput ç»„ä»¶æ·±åº¦åˆ†æ

MessageInput ç»„ä»¶å®ç°äº†æ™ºèƒ½çš„è¾“å…¥å¤„ç†æœºåˆ¶ï¼š

```mermaid
flowchart TD
Start([ç»„ä»¶åˆå§‹åŒ–]) --> InitStates[åˆå§‹åŒ–çŠ¶æ€<br/>- message<br/>- textareaRows<br/>- mode]
InitStates --> SetupEffects[è®¾ç½®æ•ˆæœç›‘å¬å™¨<br/>- é”®ç›˜äº‹ä»¶<br/>- æ–‡æœ¬åŒºåŸŸé«˜åº¦å˜åŒ–]
SetupEffects --> RenderForm[æ¸²æŸ“è¡¨å•ç»“æ„<br/>- å¤šè¡Œ/å•è¡Œæ¨¡å¼<br/>- é™„ä»¶æŒ‰é’®<br/>- æäº¤æŒ‰é’®]
RenderForm --> UserInput[ç”¨æˆ·è¾“å…¥å¤„ç†<br/>- æ–‡æœ¬å˜æ›´<br/>- é«˜åº¦è‡ªé€‚åº”]
UserInput --> SubmitLogic[æäº¤é€»è¾‘<br/>- Enteré”®æäº¤<br/>- åŠ è½½çŠ¶æ€æ£€æŸ¥]
SubmitLogic --> ClearInput[æ¸…ç©ºè¾“å…¥æ¡†]
ClearInput --> End([ç­‰å¾…ä¸‹æ¬¡è¾“å…¥])
UserInput --> HeightCalc[é«˜åº¦è®¡ç®—<br/>- åŸºäºè¡Œæ•°<br/>- æ¨¡å¼åˆ‡æ¢]
HeightCalc --> ModeChange{æ¨¡å¼å˜æ›´?}
ModeChange --> |æ˜¯| UpdateMode[æ›´æ–°æ¨¡å¼<br/>- single/multi]
ModeChange --> |å¦| WaitInput[ç­‰å¾…è¾“å…¥]
UpdateMode --> RenderForm
```

**å›¾è¡¨æ¥æº**
- [MessageInput.tsx](file://src/components/MessageInput.tsx#L16-L22)
- [MessageInput.tsx](file://src/components/MessageInput.tsx#L69-L78)

#### å¿«æ·é”®æ”¯æŒæœºåˆ¶
ç»„ä»¶å®ç°äº†å…¨å±€å¿«æ·é”®ç›‘å¬ï¼Œæä¾›æ— ç¼çš„é”®ç›˜å¯¼èˆªä½“éªŒï¼š

- **"/" é”®æ”¯æŒ**ï¼šå½“ç„¦ç‚¹ä¸åœ¨è¾“å…¥å…ƒç´ æ—¶ï¼ŒæŒ‰ä¸‹ "/" è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
- **Enter é”®æäº¤**ï¼šæ ‡å‡†çš„ Enter é”®æäº¤è¡Œä¸ºï¼ŒShift+Enter è¿›è¡Œæ¢è¡Œ
- **åŠ è½½çŠ¶æ€ä¿æŠ¤**ï¼šé˜²æ­¢åœ¨è¯·æ±‚è¿›è¡Œæ—¶é‡å¤æäº¤

#### æ–‡æœ¬è¾“å…¥å¤„ç†
- **å®æ—¶çŠ¶æ€ç®¡ç†**ï¼šä½¿ç”¨ useState ç®¡ç†è¾“å…¥å†…å®¹
- **é«˜åº¦è‡ªé€‚åº”**ï¼šé€šè¿‡ onHeightChange å›è°ƒå®ç°åŠ¨æ€é«˜åº¦è°ƒæ•´
- **å ä½ç¬¦æç¤º**ï¼šæä¾›ä¸Šä¸‹æ–‡ç›¸å…³çš„è¾“å…¥æç¤º

**ç« èŠ‚æ¥æº**
- [MessageInput.tsx](file://src/components/MessageInput.tsx#L26-L46)
- [MessageInput.tsx](file://src/components/MessageInput.tsx#L72-L75)

### EmptyChatMessageInput ç»„ä»¶åˆ†æ

EmptyChatMessageInput ä¸“ä¸ºç©ºèŠå¤©çŠ¶æ€è®¾è®¡ï¼Œæä¾›å®Œæ•´çš„é…ç½®é€‰é¡¹é¢æ¿ï¼š

```mermaid
classDiagram
class EmptyChatMessageInput {
+message : string
+inputRef : Ref
+handleKeyDown(e : KeyboardEvent)
+handleSubmit(e : Event)
+handleEnter(e : KeyboardEvent)
}
class MessageInputActions {
<<interface>>
+Optimization : Optimization
+Sources : Sources
+Attach : Attach
+ChatModelSelector : ChatModelSelector
}
EmptyChatMessageInput --> MessageInputActions : ä½¿ç”¨
MessageInputActions --> useChat : ä¾èµ–
```

**å›¾è¡¨æ¥æº**
- [EmptyChatMessageInput.tsx](file://src/components/EmptyChatMessageInput.tsx#L10-L89)

#### ç©ºçŠ¶æ€ç‰¹æ®Šå¤„ç†
- **è‡ªåŠ¨ç„¦ç‚¹**ï¼šç»„ä»¶æŒ‚è½½æ—¶è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
- **å®Œæ•´é…ç½®**ï¼šæä¾›æ‰€æœ‰å¿…è¦çš„é…ç½®é€‰é¡¹
- **ç®€åŒ–å¸ƒå±€**ï¼šä¸“æ³¨äºæ ¸å¿ƒè¾“å…¥åŠŸèƒ½

**ç« èŠ‚æ¥æº**
- [EmptyChatMessageInput.tsx](file://src/components/EmptyChatMessageInput.tsx#L18-L40)
- [EmptyChatMessageInput.tsx](file://src/components/EmptyChatMessageInput.tsx#L58-L84)

### MessageInputActions å­ç»„ä»¶è¯¦è§£

#### æ–‡ä»¶é™„ä»¶ä¸Šä¼ ç»„ä»¶ (Attach/AttachSmall)
è¿™ä¸¤ä¸ªç»„ä»¶æä¾›äº†ç›¸ä¼¼ä½†ç•¥æœ‰ä¸åŒçš„æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼š

```mermaid
flowchart LR
Click[ç‚¹å‡»é™„ä»¶æŒ‰é’®] --> FileInput[æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†]
FileInput --> FormData[æ„å»ºFormData<br/>- é€‰æ‹©çš„æ–‡ä»¶<br/>- åµŒå…¥æ¨¡å‹é…ç½®]
FormData --> Upload[å‘é€åˆ° /api/uploads]
Upload --> Loading[æ˜¾ç¤ºåŠ è½½çŠ¶æ€]
Loading --> Success[ä¸Šä¼ æˆåŠŸ<br/>- æ›´æ–°æ–‡ä»¶åˆ—è¡¨<br/>- æ¸…ç©ºæ–‡ä»¶ID]
Success --> Popup[æ˜¾ç¤ºæ–‡ä»¶å¼¹çª—]
Popup --> AddMore[æ·»åŠ æ›´å¤šæ–‡ä»¶]
Popup --> ClearAll[æ¸…é™¤æ‰€æœ‰æ–‡ä»¶]
Success --> NoFiles{æœ‰æ–‡ä»¶?}
NoFiles --> |å¦| SimpleButton[ç®€å•é™„ä»¶æŒ‰é’®]
NoFiles --> |æ˜¯| Popup
```

**å›¾è¡¨æ¥æº**
- [Attach.tsx](file://src/components/MessageInputActions/Attach.tsx#L28-L54)
- [AttachSmall.tsx](file://src/components/MessageInputActions/AttachSmall.tsx#L19-L45)

##### åŠŸèƒ½ç‰¹æ€§
- **æ‰¹é‡æ–‡ä»¶ä¸Šä¼ **ï¼šæ”¯æŒåŒæ—¶é€‰æ‹©å¤šä¸ªæ–‡ä»¶
- **åµŒå…¥æ¨¡å‹é›†æˆ**ï¼šè‡ªåŠ¨é™„åŠ åµŒå…¥æ¨¡å‹é…ç½®ä¿¡æ¯
- **æ–‡ä»¶ç®¡ç†**ï¼šæä¾›æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤ºå’Œç®¡ç†åŠŸèƒ½
- **åŠ è½½çŠ¶æ€åé¦ˆ**ï¼šä¸Šä¼ è¿‡ç¨‹ä¸­çš„è§†è§‰åé¦ˆ

##### æ”¯æŒçš„æ–‡ä»¶æ ¼å¼
- PDF æ–‡æ¡£
- DOCX æ–‡æ¡£  
- TXT æ–‡æœ¬æ–‡ä»¶

**ç« èŠ‚æ¥æº**
- [Attach.tsx](file://src/components/MessageInputActions/Attach.tsx#L28-L54)
- [AttachSmall.tsx](file://src/components/MessageInputActions/AttachSmall.tsx#L19-L45)

#### æ¨¡å‹é€‰æ‹©å™¨ç»„ä»¶ (ChatModelSelector)
æ¨¡å‹é€‰æ‹©å™¨æä¾›äº†æ™ºèƒ½çš„æ¨¡å‹é…ç½®åŠŸèƒ½ï¼š

```mermaid
sequenceDiagram
participant User as ç”¨æˆ·
participant Selector as æ¨¡å‹é€‰æ‹©å™¨
participant API as /api/providers
participant Storage as æœ¬åœ°å­˜å‚¨
User->>Selector : æ‰“å¼€æ¨¡å‹é€‰æ‹©å¼¹çª—
Selector->>API : è·å–æä¾›å•†åˆ—è¡¨
API-->>Selector : è¿”å›æä¾›å•†æ•°æ®
Selector->>Selector : æ˜¾ç¤ºæ¨¡å‹åˆ—è¡¨
User->>Selector : æœç´¢æ¨¡å‹
Selector->>Selector : è¿‡æ»¤æ¨¡å‹åˆ—è¡¨
User->>Selector : é€‰æ‹©æ¨¡å‹
Selector->>Storage : ä¿å­˜é…ç½®åˆ°localStorage
Selector->>Selector : æ›´æ–°å½“å‰æ¨¡å‹
```

**å›¾è¡¨æ¥æº**
- [ChatModelSelector.tsx](file://src/components/MessageInputActions/ChatModelSelector.tsx#L18-L38)
- [ChatModelSelector.tsx](file://src/components/MessageInputActions/ChatModelSelector.tsx#L59-L63)

##### æ ¸å¿ƒåŠŸèƒ½
- **åŠ¨æ€æä¾›å•†åŠ è½½**ï¼šä» /api/providers è·å–å¯ç”¨æ¨¡å‹
- **æ™ºèƒ½æ’åº**ï¼šå½“å‰é€‰ä¸­æ¨¡å‹ä¼˜å…ˆæ˜¾ç¤º
- **æœç´¢è¿‡æ»¤**ï¼šæ”¯æŒæŒ‰æ¨¡å‹åç§°å’Œæä¾›å•†åç§°æœç´¢
- **é…ç½®æŒä¹…åŒ–**ï¼šè‡ªåŠ¨ä¿å­˜åˆ° localStorage

##### ä¼˜åŒ–æ¨¡å¼ç®¡ç†
ç»„ä»¶ç»´æŠ¤ä»¥ä¸‹ä¼˜åŒ–æ¨¡å¼é…ç½®ï¼š

| æ¨¡å¼ | æè¿° | å›¾æ ‡ |
|------|------|------|
| speed | ä¼˜å…ˆé€Ÿåº¦ï¼Œè·å¾—æœ€å¿«å¯èƒ½çš„ç­”æ¡ˆ | âš¡ï¸ |
| balanced | åœ¨é€Ÿåº¦å’Œå‡†ç¡®æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ | ğŸ”„ |
| quality | è·å¾—æœ€å…¨é¢å’Œå‡†ç¡®çš„ç­”æ¡ˆ | âœ¨ |

**ç« èŠ‚æ¥æº**
- [ChatModelSelector.tsx](file://src/components/MessageInputActions/ChatModelSelector.tsx#L18-L38)
- [ChatModelSelector.tsx](file://src/components/MessageInputActions/ChatModelSelector.tsx#L13-L37)

#### æ¥æºç®¡ç†ç»„ä»¶ (Sources)
æ¥æºç®¡ç†ç»„ä»¶å…è®¸ç”¨æˆ·æ§åˆ¶æœç´¢æ¥æºï¼š

```mermaid
flowchart TD
Open[æ‰“å¼€æ¥æºé€‰æ‹©] --> ShowSources[æ˜¾ç¤ºæ¥æºåˆ—è¡¨]
ShowSources --> Web[Web æœç´¢<br/>ğŸŒ]
ShowSources --> Academic[å­¦æœ¯æœç´¢<br/>ğŸ“]
ShowSources --> Social[ç¤¾äº¤æœç´¢<br/>ğŸ‘¥]
Web --> ToggleWeb[åˆ‡æ¢ Web æº]
Academic --> ToggleAcademic[åˆ‡æ¢ Academic æº]
Social --> ToggleSocial[åˆ‡æ¢ Social æº]
ToggleWeb --> UpdateState[æ›´æ–°çŠ¶æ€]
ToggleAcademic --> UpdateState
ToggleSocial --> UpdateState
UpdateState --> SendRequest[å‘é€æœç´¢è¯·æ±‚]
```

**å›¾è¡¨æ¥æº**
- [Sources.tsx](file://src/components/MessageInputActions/Sources.tsx#L15-L31)

##### æ”¯æŒçš„æœç´¢æ¥æº
- **Web**ï¼šé€šç”¨ç½‘ç»œæœç´¢
- **Academic**ï¼šå­¦æœ¯è®ºæ–‡å’Œç ”ç©¶
- **Discussions**ï¼šç¤¾äº¤è®¨è®ºå’Œè®ºå›

**ç« èŠ‚æ¥æº**
- [Sources.tsx](file://src/components/MessageInputActions/Sources.tsx#L33-L94)

### çŠ¶æ€ç®¡ç†ä¸äº‹ä»¶å¤„ç†

#### useChat Hook çŠ¶æ€ç®¡ç†
useChat Hook æä¾›äº†å®Œæ•´çš„èŠå¤©çŠ¶æ€ç®¡ç†ï¼š

```mermaid
stateDiagram-v2
[*] --> åˆå§‹åŒ–
åˆå§‹åŒ– --> é…ç½®æ£€æŸ¥
é…ç½®æ£€æŸ¥ --> å‡†å¤‡å°±ç»ª
å‡†å¤‡å°±ç»ª --> ç­‰å¾…æ¶ˆæ¯
ç­‰å¾…æ¶ˆæ¯ --> å‘é€æ¶ˆæ¯
å‘é€æ¶ˆæ¯ --> æµå¼å“åº”
æµå¼å“åº” --> æ¶ˆæ¯å®Œæˆ
æ¶ˆæ¯å®Œæˆ --> ç­‰å¾…æ¶ˆæ¯
å‘é€æ¶ˆæ¯ --> é”™è¯¯å¤„ç†
é”™è¯¯å¤„ç† --> ç­‰å¾…æ¶ˆæ¯
```

**å›¾è¡¨æ¥æº**
- [useChat.tsx](file://src/lib/hooks/useChat.tsx#L270-L842)

#### äº‹ä»¶å¤„ç†æœºåˆ¶
ç»„ä»¶é‡‡ç”¨äº†å¤šå±‚æ¬¡çš„äº‹ä»¶å¤„ç†æœºåˆ¶ï¼š

1. **æœ¬åœ°äº‹ä»¶å¤„ç†**ï¼šç»„ä»¶å†…éƒ¨çš„çŠ¶æ€æ›´æ–°å’Œ UI äº¤äº’
2. **å…¨å±€é”®ç›˜äº‹ä»¶**ï¼šæ–‡æ¡£çº§åˆ«çš„å¿«æ·é”®æ”¯æŒ
3. **çŠ¶æ€åŒæ­¥**ï¼šé€šè¿‡ useChat Hook å®ç°è·¨ç»„ä»¶çŠ¶æ€å…±äº«
4. **æµå¼å“åº”**ï¼šåç«¯çš„å®æ—¶æ•°æ®æµå¤„ç†

**ç« èŠ‚æ¥æº**
- [useChat.tsx](file://src/lib/hooks/useChat.tsx#L550-L806)

## ä¾èµ–å…³ç³»åˆ†æ

### ç»„ä»¶ä¾èµ–å›¾
æ¶ˆæ¯è¾“å…¥ç»„ä»¶ä¹‹é—´çš„ä¾èµ–å…³ç³»å¦‚ä¸‹ï¼š

```mermaid
graph TB
subgraph "è¾“å…¥ç»„ä»¶"
MI[MessageInput]
EMI[EmptyChatMessageInput]
end
subgraph "åŠ¨ä½œç»„ä»¶"
ATT[Attach]
ATTS[AttachSmall]
MS[ChatModelSelector]
OPT[Optimization]
SRC[Sources]
end
subgraph "çŠ¶æ€ç®¡ç†"
UC[useChat Hook]
ACT[actions.ts]
end
MI --> ATTS
EMI --> ATT
EMI --> MS
EMI --> OPT
EMI --> SRC
ATT --> UC
ATTS --> UC
MS --> UC
OPT --> UC
SRC --> UC
UC --> ACT
```

**å›¾è¡¨æ¥æº**
- [MessageInput.tsx](file://src/components/MessageInput.tsx#L1-L6)
- [EmptyChatMessageInput.tsx](file://src/components/EmptyChatMessageInput.tsx#L1-L8)

### å¤–éƒ¨ä¾èµ–
ç»„ä»¶ä¾èµ–çš„ä¸»è¦å¤–éƒ¨åº“å’Œå·¥å…·ï¼š

- **Lucide React**ï¼šå›¾æ ‡åº“ï¼Œæä¾›ç»Ÿä¸€çš„è§†è§‰å…ƒç´ 
- **Headless UI**ï¼šæ— æ ·å¼ UI ç»„ä»¶åº“ï¼Œæä¾›å¯è®¿é—®æ€§å‹å¥½çš„ç»„ä»¶
- **Framer Motion**ï¼šåŠ¨ç”»åº“ï¼Œæä¾›æµç•…çš„è¿‡æ¸¡æ•ˆæœ
- **React Textarea Autosize**ï¼šæ–‡æœ¬åŒºåŸŸè‡ªé€‚åº”é«˜åº¦åº“

**ç« èŠ‚æ¥æº**
- [Attach.tsx](file://src/components/MessageInputActions/Attach.tsx#L1-L21)
- [ChatModelSelector.tsx](file://src/components/MessageInputActions/ChatModelSelector.tsx#L1-L9)

## æ€§èƒ½è€ƒè™‘
æ¶ˆæ¯è¾“å…¥ç»„ä»¶åœ¨è®¾è®¡æ—¶å……åˆ†è€ƒè™‘äº†æ€§èƒ½ä¼˜åŒ–ï¼š

### æ¸²æŸ“ä¼˜åŒ–
- **æ¡ä»¶æ¸²æŸ“**ï¼šæ ¹æ®æ¨¡å¼å’ŒçŠ¶æ€åŠ¨æ€æ¸²æŸ“ç»„ä»¶
- **æ‡’åŠ è½½**ï¼šå¼¹çª—ç»„ä»¶ä»…åœ¨éœ€è¦æ—¶åŠ è½½
- **è™šæ‹Ÿæ»šåŠ¨**ï¼šé•¿åˆ—è¡¨ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–

### ç½‘ç»œä¼˜åŒ–
- **æµå¼ä¼ è¾“**ï¼šåç«¯ä½¿ç”¨æµå¼å“åº”å‡å°‘å»¶è¿Ÿ
- **ç¼“å­˜ç­–ç•¥**ï¼šæä¾›å•†é…ç½®ä¿¡æ¯æœ¬åœ°ç¼“å­˜
- **é˜²æŠ–å¤„ç†**ï¼šæœç´¢å’Œè¿‡æ»¤æ“ä½œçš„é˜²æŠ–ä¼˜åŒ–

### å†…å­˜ç®¡ç†
- **å¼•ç”¨æ¸…ç†**ï¼šåŠæ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨å’Œå®šæ—¶å™¨
- **çŠ¶æ€æœ€å°åŒ–**ï¼šåªå­˜å‚¨å¿…è¦çš„çŠ¶æ€ä¿¡æ¯
- **åƒåœ¾å›æ”¶**ï¼šé¿å…å†…å­˜æ³„æ¼çš„èµ„æºç®¡ç†

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜è¯Šæ–­
1. **è¾“å…¥æ¡†æ— æ³•èšç„¦**
   - æ£€æŸ¥å…¨å±€é”®ç›˜äº‹ä»¶æ˜¯å¦æ­£ç¡®ç»‘å®š
   - éªŒè¯ç„¦ç‚¹ç®¡ç†é€»è¾‘

2. **æ–‡ä»¶ä¸Šä¼ å¤±è´¥**
   - æ£€æŸ¥ /api/uploads ç«¯ç‚¹çŠ¶æ€
   - éªŒè¯æ–‡ä»¶å¤§å°å’Œæ ¼å¼é™åˆ¶

3. **æ¨¡å‹é€‰æ‹©å™¨æ— å“åº”**
   - ç¡®è®¤ /api/providers ç«¯ç‚¹å¯ç”¨æ€§
   - æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€

### è°ƒè¯•å»ºè®®
- ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ç›‘æ§ç½‘ç»œè¯·æ±‚
- æ£€æŸ¥æ§åˆ¶å°é”™è¯¯æ—¥å¿—
- éªŒè¯çŠ¶æ€æ›´æ–°çš„æ—¶åºå…³ç³»

**ç« èŠ‚æ¥æº**
- [useChat.tsx](file://src/lib/hooks/useChat.tsx#L554-L565)

## ç»“è®º
æ¶ˆæ¯è¾“å…¥ç»„ä»¶ç³»ç»Ÿå±•ç°äº†ç°ä»£ React åº”ç”¨çš„æœ€ä½³å®è·µï¼Œé€šè¿‡æ¨¡å—åŒ–è®¾è®¡ã€çŠ¶æ€ç®¡ç†å’Œäº‹ä»¶å¤„ç†å®ç°äº†å®Œæ•´çš„ç”¨æˆ·è¾“å…¥ä½“éªŒã€‚ç»„ä»¶æ¶æ„æ¸…æ™°ï¼ŒåŠŸèƒ½ä¸°å¯Œï¼ŒåŒæ—¶ä¿æŒäº†è‰¯å¥½çš„æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚é€šè¿‡ useChat Hook çš„çŠ¶æ€ç®¡ç†ï¼Œå„ä¸ªè¾“å…¥ç»„ä»¶èƒ½å¤Ÿé«˜æ•ˆåä½œï¼Œä¸ºç”¨æˆ·æä¾›æµç•…çš„æ¶ˆæ¯è¾“å…¥ä½“éªŒã€‚