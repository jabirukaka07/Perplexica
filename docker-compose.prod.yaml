# ========================================
# 生产环境 Docker Compose 配置
# ========================================
# 使用方式: docker-compose -f docker-compose.prod.yaml up -d
# 
# 注意事项:
# 1. 生产环境不使用 .env 文件，通过以下方式注入环境变量：
#    - 直接在 docker-compose 命令中: docker-compose -f docker-compose.prod.yaml up -d
#      然后通过 -e 参数或系统环境变量传递
#    - 云平台配置管理（如 AWS Secrets Manager, Azure Key Vault）
#    - Kubernetes ConfigMap/Secret
# 2. 必须配置的环境变量：
#    - JWT_SECRET: JWT 签名密钥
#    - OIDC_ISSUER: OIDC 提供商地址
#    - OIDC_CLIENT_ID: OIDC 客户端 ID
#    - OIDC_CLIENT_SECRET: OIDC 客户端密钥
#    - OIDC_REDIRECT_URI: OIDC 回调地址
#    - OIDC_ADMIN_EMAILS: 管理员邮箱列表

services:
  perplexica:
    image: itzcrazykns1337/perplexica:latest
    ports:
      - '3000:3000'
    volumes:
      - perplexica-data:/home/perplexica/data
    environment:
      # 从宿主机环境变量或命令行传入
      - JWT_SECRET=${JWT_SECRET}
      - OIDC_ISSUER=${OIDC_ISSUER}
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID}
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET}
      - OIDC_REDIRECT_URI=${OIDC_REDIRECT_URI}
      - OIDC_ADMIN_EMAILS=${OIDC_ADMIN_EMAILS}
      - SEARXNG_API_URL=http://searxng:8080
      - DATA_DIR=
    restart: always
    depends_on:
      - searxng
    # 生产环境健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/config"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  searxng:
    image: searxng/searxng:latest
    ports:
      - '4000:8080'
    volumes:
      - ./searxng-settings.yml:/etc/searxng/settings.yml
    restart: always
    # 生产环境健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  perplexica-data:
    name: 'perplexica-data-prod'
